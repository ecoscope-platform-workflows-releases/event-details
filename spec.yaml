id: event_details
requirements:
  - name: ecoscope-workflows-core
    version: 0.21.3
    channel: https://repo.prefix.dev/ecoscope-workflows/
  - name: ecoscope-workflows-ext-ecoscope
    version: 0.21.3
    channel: https://repo.prefix.dev/ecoscope-workflows/
rjsf-overrides:
  properties:
    set_event_details_combined.properties.event_type.ecoscope:event_type_schema_properties: properties.er_client_name.properties.data_source.properties.name
    set_event_details_combined.properties.analysis_field.ecoscope:event_type_schema_numeric_prop: properties.set_event_details_combined.properties.event_type
    set_event_details_combined.properties.category_field.ecoscope:event_type_schema_choice_prop: properties.set_event_details_combined.properties.event_type
  $defs:
    ValueGrouper.oneOf:
      - const: Event Category
        title: Event Category
      - const: Reported By
        title: Reported By Name
  uiSchema:
    set_event_details_combined.event_types.ui:options.displayLabel: false
    filter_events.filter_point_coords.items.ui:options.label: false
    base_map_defs.base_maps.items.ui:options.label: false
    Event Density Map.events_meshgrid.auto_scale_or_custom_cell_size:
      anyOf:
        - ui:help: Auto-scale for an optimized grid cell size based the workflow data or Customize to set a specific grid cell size.
          ui:options:
            label: false
          auto_scale_or_custom:
            ui:widget: hidden
        - ui:options:
            label: false
          auto_scale_or_custom:
            ui:widget: hidden
      auto_scale_or_custom:
        ui:widget: hidden
task-instance-defaults:
  skipif:
    conditions:
      - any_is_empty_df
      - any_dependency_skipped
workflow:
  - name: Workflow Details
    id: workflow_details
    task: set_workflow_details
  - name: Data Source
    id: er_client_name
    task: set_er_connection
  - name: Time Range
    id: time_range
    task: set_time_range
    partial:
      time_format: '%d %b %Y %H:%M:%S'
  - name: Extract Timezone Selection
    id: get_timezone
    task: get_timezone_from_time_range
    partial:
      time_range: ${{ workflow.time_range.return }}
  - name: Event Types
    id: set_event_details_combined
    task: set_event_details_params
    partial:
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      event_columns:
        - id
        - time
        - event_type
        - event_category
        - reported_by
        - serial_number
        - location
        - event_details
        - geometry
      raise_on_empty: false
      include_details: true
      include_updates: false
      include_related_events: false
      include_display_values: false
  - id: get_events_data
    task: get_events_from_combined_params
    partial:
      combined_params: ${{ workflow.set_event_details_combined.return }}
  - name: Convert to timezone
    id: convert_to_user_timezone
    task: convert_values_to_timezone
    partial:
      df: ${{ workflow.get_events_data.return }}
      timezone: ${{ workflow.get_timezone.return }}
      columns:
        - time
  - name: Extract Latitude from Events
    id: extract_latitude
    task: extract_value_from_json_column
    partial:
      df: ${{ workflow.convert_to_user_timezone.return }}
      column_name: location
      field_name_options:
        - latitude
      output_type: str
      output_column_name: latitude
  - name: Extract Longitude from Events
    id: extract_longitude
    task: extract_value_from_json_column
    partial:
      df: ${{ workflow.extract_latitude.return }}
      column_name: location
      field_name_options:
        - longitude
      output_type: str
      output_column_name: longitude
  - name: Extract reported_by_name from Events
    id: extract_reported_by
    task: extract_value_from_json_column
    partial:
      df: ${{ workflow.extract_longitude.return }}
      column_name: reported_by
      field_name_options:
        - name
      output_type: str
      output_column_name: reported_by_name
  - name: Group Data
    id: groupers
    task: set_groupers
  - name: Event Location Filter
    id: filter_events
    task: apply_reloc_coord_filter
    partial:
      df: ${{ workflow.extract_reported_by.return }}
      roi_gdf: null
      roi_name: null
      reset_index: true
  - name: Normalize event details
    id: normalize_event_details
    task: normalize_json_column
    partial:
      df: ${{ workflow.filter_events.return }}
      column: event_details
      skip_if_not_exists: false
      sort_columns: false
  - name: Add temporal index to Events
    id: events_add_temporal_index
    task: add_temporal_index
    partial:
      df: ${{ workflow.normalize_event_details.return }}
      time_col: time
      groupers: ${{ workflow.groupers.return }}
      cast_to_datetime: true
      format: mixed
  - id: analysis_field_from_config
    task: get_analysis_field_from_event_details
    partial:
      combined_params: ${{ workflow.set_event_details_combined.return }}
  - id: analysis_field
    task: title_case_var
    partial:
      var: ${{ workflow.analysis_field_from_config.return }}
  - id: analysis_field_label
    task: get_analysis_field_label_from_event_details
    partial:
      combined_params: ${{ workflow.set_event_details_combined.return }}
  - id: analysis_field_unit
    task: get_analysis_field_unit_from_event_details
    partial:
      combined_params: ${{ workflow.set_event_details_combined.return }}
  - id: category_field_from_config
    task: get_category_field_from_event_details
    partial:
      combined_params: ${{ workflow.set_event_details_combined.return }}
  - id: category_field
    task: title_case_var
    skipif:
      conditions:
        - any_dependency_is_none
    partial:
      var: ${{ workflow.category_field_from_config.return }}
  - id: category_field_label
    task: get_category_field_label_from_event_details
    skipif:
      conditions:
        - any_dependency_is_none
    partial:
      combined_params: ${{ workflow.set_event_details_combined.return }}
  - id: event_type
    task: get_event_type_from_event_details
    partial:
      combined_params: ${{ workflow.set_event_details_combined.return }}
  - id: add_default_category_column
    task: assign_value
    partial:
      df: ${{ workflow.events_add_temporal_index.return }}
      column_name: default_category
      value: ${{ workflow.analysis_field_unit.return }}
      noop_if_column_exists: false
  - id: default_category_field
    task: default_if_string_is_empty
    partial:
      value: ${{ workflow.category_field.return }}
      default: default_category
  - id: category_field_label_or_category
    task: default_if_string_is_empty
    partial:
      value: ${{ workflow.category_field_label.return }}
      default: ${{ workflow.category_field.return }}
  - id: default_category_field_label
    task: default_if_string_is_empty
    partial:
      value: ${{ workflow.category_field_label_or_category.return }}
      default: ${{ workflow.category_field.return }}
  - id: title_case_columns
    task: title_case_columns_by_prefix
    partial:
      df: ${{ workflow.add_default_category_column.return }}
      prefix: event_details__
  - id: get_category_display_names
    task: get_choices_from_v2_event_type
    partial:
      client: ${{ workflow.er_client_name.return }}
      event_type: ${{ workflow.event_type.return }}
      choice_field: ${{ workflow.category_field_from_config.return }}
  - id: ensure_analysis_column
    task: assign_value
    partial:
      df: ${{ workflow.title_case_columns.return }}
      column_name: ${{ workflow.analysis_field.return }}
      value: null
      noop_if_column_exists: true
  - id: ensure_category_column
    task: assign_value
    partial:
      df: ${{ workflow.ensure_analysis_column.return }}
      column_name: ${{ workflow.default_category_field.return }}
      value: None
      noop_if_column_exists: true
  - id: map_display_names
    task: map_values
    partial:
      df: ${{ workflow.ensure_category_column.return }}
      column_name: ${{ workflow.default_category_field.return }}
      value_map: ${{ workflow.get_category_display_names.return }}
      missing_values: preserve
      replacement: null
  - id: convert_na_values
    task: fill_na
    partial:
      df: ${{ workflow.map_display_names.return }}
      value: None
      columns:
        - ${{ workflow.default_category_field.return }}
  - name: Rename columns for display
    id: rename_columns
    task: map_columns
    partial:
      df: ${{ workflow.convert_na_values.return }}
      drop_columns:
        - reported_by
        - location
        - Updates
      retain_columns: []
      rename_columns:
        serial_number: Serial Number
        time: Event Time
        reported_by_name: Reported By
        latitude: Latitude
        longitude: Longitude
        event_category: Event Category
  - name: Reorder columns for display
    id: column_display_order
    task: reorder_columns
    partial:
      df: ${{ workflow.rename_columns.return }}
      columns:
        - Serial Number
        - Event Time
        - Reported By
        - Latitude
        - Longitude
  - name: Ensure Numeric Analysis Field
    id: ensure_numeric
    task: convert_column_values_to_numeric
    partial:
      df: ${{ workflow.rename_columns.return }}
      columns:
        - ${{ workflow.analysis_field.return }}
  - name: Events Colormap
    id: events_colormap
    task: apply_color_map
    partial:
      df: ${{ workflow.ensure_numeric.return }}
      input_column_name: ${{ workflow.default_category_field.return }}
      colormap:
        - '#312B86'
        - '#08D1CC'
        - '#FF3FB3'
        - '#20BF55'
        - '#FF9F1C'
        - '#6460B0'
        - '#FF7FCC'
        - '#4DE3DD'
        - '#6BE39A'
        - '#FFC46F'
        - '#1E215C'
        - '#C80088'
        - '#008784'
        - '#08853A'
        - '#C46C00'
      output_column_name: events_colormap
  - id: set_summary_table_title
    task: set_string_var
    partial:
      var: ${{ workflow.analysis_field_label.return }}
  - id: by_category_field_str
    task: concat_string_vars
    skipif:
      conditions:
        - any_dependency_is_empty_string
    partial:
      values:
        - ' by '
        - ${{ workflow.category_field_label.return }}
  - id: pie_chart_title_pt1
    task: concat_string_vars
    partial:
      values:
        - 'Proportion of '
        - ${{ workflow.analysis_field_label.return }}
  - id: set_pie_chart_title
    task: concat_string_vars
    skipif:
      conditions:
        - never
    partial:
      values:
        - ${{ workflow.pie_chart_title_pt1.return }}
        - ${{ workflow.by_category_field_str.return }}
  - id: set_events_map_title
    task: concat_string_vars
    skipif:
      conditions:
        - never
    partial:
      values:
        - ${{ workflow.analysis_field_label.return }}
        - ${{ workflow.by_category_field_str.return }}
        - ' Locations'
  - id: set_bar_chart_title
    task: concat_string_vars
    skipif:
      conditions:
        - never
    partial:
      values:
        - ${{ workflow.analysis_field_label.return }}
        - ${{ workflow.by_category_field_str.return }}
        - ' Over Time'
  - name: Set Density Map Title
    id: set_density_map_title
    task: concat_string_vars
    partial:
      values:
        - ${{ workflow.analysis_field_label.return }}
        - ' Sum'
  - id: set_events_table_title
    task: set_string_var
    partial:
      var: Events Table
  - name: Split Events by Group
    id: split_event_groups
    task: split_groups
    partial:
      df: ${{ workflow.events_colormap.return }}
      groupers: ${{ workflow.groupers.return }}
  - id: drop_nan_values
    task: drop_nan_values_by_column
    partial:
      column_name: ${{ workflow.analysis_field.return }}
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.split_event_groups.return }}
  - name: Map Base Layers
    id: base_map_defs
    task: set_base_maps
  - name: Calculate Total Events Per Group
    id: total_events
    task: dataframe_count
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.split_event_groups.return }}
  - name: Create Events Single Value Widget
    id: total_events_sv_widget
    task: create_single_value_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: Event Count
      decimal_places: 1
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.total_events.return }}
  - name: Merge per group Total Patrols SV widgets
    id: total_events_grouped_sv_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.total_events_sv_widget.return }}
  - name: Summarize events
    id: grouped_event_summary
    task: summarize_df
    partial:
      summary_params:
        - display_name: Sum
          aggregator: sum
          column: ${{ workflow.analysis_field.return }}
        - display_name: Min
          aggregator: min
          column: ${{ workflow.analysis_field.return }}
        - display_name: Max
          aggregator: max
          column: ${{ workflow.analysis_field.return }}
        - display_name: Median
          aggregator: median
          column: ${{ workflow.analysis_field.return }}
        - display_name: Mean
          aggregator: mean
          column: ${{ workflow.analysis_field.return }}
      groupby_cols: null
      reset_index: false
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.drop_nan_values.return }}
  - name: Transpose Table
    id: transpose_table
    task: transpose
    partial:
      transposed_column_name: Summary Stats
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.grouped_event_summary.return }}
  - name: Rename summary column
    id: rename_summary_columns
    task: map_columns
    partial:
      drop_columns: []
      retain_columns: []
      rename_columns:
        "0": Summary Values
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.transpose_table.return }}
  - name: Summary Table
    id: summary_table
    task: draw_table
    partial:
      columns:
        - Summary Stats
        - Summary Values
      table_config:
        enable_sorting: true
        enable_filtering: false
        enable_download: true
        hide_header: true
      widget_id: ${{ workflow.set_summary_table_title.return }}
    mapvalues:
      argnames: dataframe
      argvalues: ${{ workflow.rename_summary_columns.return }}
  - name: Persist Summary Table as Text
    id: summary_html_urls
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename_suffix: v2
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.summary_table.return }}
  - name: Create Table Widget for Summary
    id: summary_table_single_views
    task: create_table_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: ${{ workflow.set_summary_table_title.return }}
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.summary_html_urls.return }}
  - name: Merge Summary Table Widget Views
    id: grouped_summary_table_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.summary_table_single_views.return }}
  - name: Draw Pie Chart for Events
    id: grouped_events_pie_chart
    task: draw_pie_chart
    partial:
      value_column: ${{ workflow.analysis_field.return }}
      color_column: events_colormap
      plot_style:
        textinfo: value
      label_column: ${{ workflow.default_category_field.return }}
      layout_style: null
      widget_id: ${{ workflow.set_pie_chart_title.return }}
    mapvalues:
      argnames: dataframe
      argvalues: ${{ workflow.drop_nan_values.return }}
  - name: Persist Pie Chart as Text
    id: grouped_pie_chart_html_urls
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename_suffix: v2
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.grouped_events_pie_chart.return }}
  - name: Create Plot Widget for Events
    id: grouped_events_pie_chart_widgets
    task: create_plot_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: ${{ workflow.set_pie_chart_title.return }}
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.grouped_pie_chart_html_urls.return }}
  - name: Merge Pie Chart Widget Views
    id: grouped_events_pie_widget_merge
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.grouped_events_pie_chart_widgets.return }}
  - name: Normalize numeric values
    id: normalize_analysis_field
    task: normalize_numeric_column
    partial:
      column: ${{ workflow.analysis_field.return }}
      output_column_name: normalized_analysis_field
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.split_event_groups.return }}
  - id: drop_empty_geometry
    task: drop_null_geometry
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.normalize_analysis_field.return }}
  - name: Create map layer from grouped Events
    id: grouped_events_map_layer
    task: create_point_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
        - all_geometry_are_none
    partial:
      layer_style:
        fill_color_column: events_colormap
        get_radius: normalized_analysis_field
        stroked: true
        get_line_color: '#FFFFFF'
        radius_scale: 5
      legend:
        label_column: ${{ workflow.default_category_field.return }}
        color_column: events_colormap
      tooltip_columns:
        - Serial Number
        - Event Time
        - Reported By
        - ${{ workflow.analysis_field.return }}
    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.drop_empty_geometry.return }}
  - name: Draw Ecomap from grouped Events
    id: grouped_events_ecomap
    task: draw_ecomap
    partial:
      title: null
      tile_layers: ${{ workflow.base_map_defs.return }}
      north_arrow_style:
        placement: top-left
      legend_style:
        title: ${{ workflow.default_category_field_label.return }}
        format_title: false
        placement: bottom-right
      static: false
      max_zoom: 20
      widget_id: ${{ workflow.set_events_map_title.return }}
    mapvalues:
      argnames: geo_layers
      argvalues: ${{ workflow.grouped_events_map_layer.return }}
  - name: Persist grouped Events Ecomap as Text
    id: grouped_events_ecomap_html_url
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename_suffix: v2
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.grouped_events_ecomap.return }}
  - name: Create grouped Events Map Widget
    id: grouped_events_map_widget
    task: create_map_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: ${{ workflow.set_events_map_title.return }}
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.grouped_events_ecomap_html_url.return }}
  - name: Merge Events Map Widget Views
    id: grouped_events_map_widget_merge
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.grouped_events_map_widget.return }}
  - title: Events Bar Chart
    type: task-group
    description: The bar chart shows how many events of different types occurred over time. Choose the time interval for the x-axis to control how event counts are summarized over time.
    tasks:
      - name: null
        id: events_bar_chart
        task: draw_time_series_bar_chart
        partial:
          x_axis: Event Time
          y_axis: ${{ workflow.analysis_field.return }}
          category: ${{ workflow.default_category_field.return }}
          agg_function: sum
          color_column: events_colormap
          plot_style:
            xperiodalignment: middle
          layout_style: null
          widget_id: ${{ workflow.set_bar_chart_title.return }}
        mapvalues:
          argnames: dataframe
          argvalues: ${{ workflow.drop_nan_values.return }}
      - name: Persist Bar Chart as Text
        id: events_bar_chart_html_url
        task: persist_text
        partial:
          root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
          filename_suffix: v2
        mapvalues:
          argnames: text
          argvalues: ${{ workflow.events_bar_chart.return }}
      - name: Create Bar Plot Widget for Events
        id: events_bar_chart_widget
        task: create_plot_widget_single_view
        skipif:
          conditions:
            - never
        partial:
          title: ${{ workflow.set_bar_chart_title.return }}
        map:
          argnames:
            - view
            - data
          argvalues: ${{ workflow.events_bar_chart_html_url.return }}
      - name: Merge Bar Plot Widget Views
        id: grouped_bar_plot_widget_merge
        task: merge_widget_views
        partial:
          widgets: ${{ workflow.events_bar_chart_widget.return }}
  - title: Event Density Map
    type: task-group
    description: These settings generate a grid-based heatmap showing where events are concentrated.
    tasks:
      - name: null
        id: events_meshgrid
        task: create_meshgrid
        skipif:
          conditions:
            - any_is_empty_df
            - any_dependency_skipped
            - all_geometry_are_none
        partial:
          aoi: ${{ workflow.events_add_temporal_index.return }}
          intersecting_only: false
      - name: Grouped Events Feature Density
        id: grouped_events_feature_density
        task: calculate_feature_density
        partial:
          meshgrid: ${{ workflow.events_meshgrid.return }}
          geometry_type: point
          sum_column: ${{ workflow.analysis_field.return }}
        mapvalues:
          argnames: geodataframe
          argvalues: ${{ workflow.split_event_groups.return }}
      - name: Drop nan percentiles for map display
        id: drop_nan_percentiles
        task: drop_nan_values_by_column
        partial:
          column_name: density
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.grouped_events_feature_density.return }}
      - name: Sort Density By Classification
        id: sort_grouped_density_values
        task: sort_values
        partial:
          column_name: density
          ascending: true
          na_position: last
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.drop_nan_percentiles.return }}
      - name: Classify Density Values
        id: classify_fd
        task: apply_classification
        partial:
          input_column_name: density
          output_column_name: density_bins
          classification_options:
            scheme: equal_interval
            k: 9
          label_options:
            label_ranges: true
            label_decimals: 0
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.sort_grouped_density_values.return }}
      - name: Grouped Feature Density Colormap
        id: grouped_fd_colormap
        task: apply_color_map
        partial:
          input_column_name: density_bins
          colormap:
            - '#5C4FE7'
            - '#269CD5'
            - '#00D0C8'
            - '#81D670'
            - '#FFD000'
            - '#F9BB12'
            - '#FF9600'
            - '#FA7306'
            - '#F23B0E'
          output_column_name: density_colormap
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.classify_fd.return }}
      - name: Rename columns for map tooltip display
        id: fd_rename_columns
        task: map_columns
        partial:
          drop_columns: []
          retain_columns: []
          rename_columns:
            density: Density
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.grouped_fd_colormap.return }}
      - name: Create map layer from Feature Density
        id: grouped_fd_map_layer
        task: create_polygon_layer
        skipif:
          conditions:
            - any_is_empty_df
            - any_dependency_skipped
            - all_geometry_are_none
        partial:
          layer_style:
            fill_color_column: density_colormap
            get_line_width: 0
            opacity: 0.400000
          legend:
            label_column: density_bins
            color_column: density_colormap
          tooltip_columns:
            - Density
        mapvalues:
          argnames: geodataframe
          argvalues: ${{ workflow.fd_rename_columns.return}}
      - name: Draw Ecomap from Feature Density
        id: grouped_fd_ecomap
        task: draw_ecomap
        partial:
          title: null
          tile_layers: ${{ workflow.base_map_defs.return }}
          north_arrow_style:
            placement: top-left
          legend_style:
            title: ${{ workflow.analysis_field_unit.return }}
            format_title: false
            placement: bottom-right
          static: false
          max_zoom: 20
          widget_id: ${{ workflow.set_density_map_title.return }}
        mapvalues:
          argnames: geo_layers
          argvalues: ${{ workflow.grouped_fd_map_layer.return }}
      - name: Persist Feature Density Ecomap as Text
        id: grouped_fd_ecomap_html_url
        task: persist_text
        partial:
          root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
          filename_suffix: v2
        mapvalues:
          argnames: text
          argvalues: ${{ workflow.grouped_fd_ecomap.return }}
      - name: Create Feature Density Map Widget
        id: grouped_fd_map_widget
        task: create_map_widget_single_view
        skipif:
          conditions:
            - never
        partial:
          title: ${{ workflow.set_density_map_title.return }}
        map:
          argnames:
            - view
            - data
          argvalues: ${{ workflow.grouped_fd_ecomap_html_url.return }}
      - name: Merge Feature Density Widget Views
        id: grouped_fd_map_widget_merge
        task: merge_widget_views
        partial:
          widgets: ${{ workflow.grouped_fd_map_widget.return }}
  - id: events_table_columns
    task: get_column_names_from_dataframe
    partial:
      df: ${{ workflow.column_display_order.return }}
      exclude_column_names:
        - id
        - geometry
        - events_colormap
        - event_type
        - default_category
        - Event Category
  - name: Events Table
    id: events_table
    task: draw_table
    partial:
      columns: ${{ workflow.events_table_columns.return }}
      table_config:
        enable_sorting: true
        enable_filtering: false
        enable_download: true
        hide_header: false
      widget_id: ${{ workflow.set_events_table_title.return }}
    mapvalues:
      argnames: dataframe
      argvalues: ${{ workflow.split_event_groups.return }}
  - name: Persist Events Table as Text
    id: table_html_urls
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename_suffix: v2
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.events_table.return }}
  - name: Create Table Widgets for Events
    id: events_table_single_views
    task: create_table_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: ${{ workflow.set_events_table_title.return }}
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.table_html_urls.return }}
  - name: Merge Table Widget Views
    id: grouped_table_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.events_table_single_views.return }}
  - name: Create Dashboard with Map Widgets
    id: events_dashboard
    task: gather_dashboard
    partial:
      details: ${{ workflow.workflow_details.return}}
      widgets:
        - ${{ workflow.total_events_grouped_sv_widget.return }}
        - ${{ workflow.grouped_summary_table_widget.return }}
        - ${{ workflow.grouped_events_pie_widget_merge.return }}
        - ${{ workflow.grouped_events_map_widget_merge.return }}
        - ${{ workflow.grouped_bar_plot_widget_merge.return }}
        - ${{ workflow.grouped_fd_map_widget_merge.return }}
        - ${{ workflow.grouped_table_widget.return }}
      groupers: ${{ workflow.groupers.return }}
      time_range: ${{ workflow.time_range.return}}
